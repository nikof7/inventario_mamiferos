---
title: "Tasa de registros Incidencia por área protegida"
output: html_notebook
---

```{r}
library(tidyverse)
library(rmarkdown)
```


# Carga de datos

```{r}
load("data/planilla_general.RData")
```

## Datos de registros

```{r echo = FALSE}
gatos <- datos %>% 
  filter(is.na(type)) %>%
  filter(species == "Fcat") %>% 
  mutate(type = "Mammal",
         group = "Domestico")

datos_sin_gatosNA <- datos %>% 
  filter(!(is.na(type) & species == "Fcat"))
  
data <- datos_sin_gatosNA %>% 
  rbind(.,gatos) %>% 
  filter(type == "Mammal") %>% 
  select(sitio = site, camara = camera, datetime, grupo = group, especie = species)

rm(datos, datos_sin_gatosNA, gatos)
```

## Esuferzo y cámaras instaladas

```{r}
# Cargo esfuerzo por cámara
info_camaras <- read.csv("data/info_dispositivos.csv") %>% 
  filter(tipo_dispositivo == "camera") %>% 
  select(sitio, id_dispositivo, esfuerzo) %>% 
  select(sitio, id_dispositivo, esfuerzo) %>% 
  drop_na() %>% 
  group_by(sitio) %>% 
  summarize(esfuerzo_total = sum(esfuerzo), n_camaras_totales = n_distinct(id_dispositivo))

paged_table(info_camaras)
```

# Datos generales

## Especies por área protegida

```{r}
data %>% 
  select(sitio, especie) %>% 
  group_by(sitio) %>% 
  distinct() %>%
  group_by(sitio, especie) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  spread(sitio, n, fill = 0)
```

## Cantidad de áreas en que se registró cada especie

```{r}
data %>% 
  select(sitio, especie) %>% 
  group_by(sitio) %>% 
  distinct() %>%
  group_by(especie) %>%
  summarize(n = n())
```

# Tasa de registro

# Incidencia

Para cada área protegida: n° de cámaras con registro / total de cámaras utilizadas

```{r warning=FALSE, message=FALSE}
incidencia_por_ap <- data %>% 
  select(sitio, camara, especie) %>% # Me quedo solo con las columnas de interés
  group_by(sitio, especie) %>% 
  summarize(num_camaras = n_distinct(camara)) %>% # Me quedo con la cantidad de cámaras que tuvo registro de cada especie, por área protegida.
  left_join(info_camaras, by = join_by(sitio)) %>% # Asocio esos datos con la información de cada cámara (esfuerzo y total de cámaras utilizadas)
  group_by(sitio, especie) %>% 
  mutate(incidencia = round((num_camaras/n_camaras_totales)*100, 2)) %>%  # Calculo incidencia
  select(sitio, especie, incidencia)

incidencia_total <- calculo_incidencia %>% 
  select(sitio, especie, incidencia) %>%
  group_by(especie) %>%
  summarise(promedio_incidencia = round(mean(incidencia),2) , sd_incidencia = round(sd(incidencia),2)) %>% 
  arrange(-sd_incidencia)

paged_table(incidencia_por_ap)
paged_table(incidencia_total)
```

